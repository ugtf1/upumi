name: UPUMI CI/CD to Cloud Run (web + api) - path filtered

on:
  push:
    branches: [ master ]
    paths:
      - "web/**"
      - "services/upumi-backend/**"
      - ".github/workflows/deploy.yml"
  workflow_dispatch:

env:
  PROJECT_ID: top-cedar-471512-k3
  PROJECT_NUMBER: 30228073381
  REGION: us-east1

  WEB_SERVICE_NAME: upumi
  API_SERVICE_NAME: upumi-api

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      web: ${{ steps.filter.outputs.web }}
      api: ${{ steps.filter.outputs.api }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            web:
              - 'web/**'
              - '.github/workflows/deploy.yml'
            api:
              - 'services/upumi-backend/**'
              - '.github/workflows/deploy.yml'

  # 1) Build + Deploy WEB (only if web changed)
  deploy-web:
    needs: detect-changes
    if: needs.detect-changes.outputs.web == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: "read"
      id-token: "write"
    outputs:
      web_url: ${{ steps.urls.outputs.web_url }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud (WIF)
        uses: google-github-actions/auth@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
          workload_identity_provider: projects/${{ env.PROJECT_NUMBER }}/locations/global/workloadIdentityPools/ugtf-github-pool/providers/github-actions
          service_account: github-runner-ugtf@${{ env.PROJECT_ID }}.iam.gserviceaccount.com

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Build and Push WEB Docker Image
        id: build_web
        run: |
          IMAGE_TAG="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.WEB_SERVICE_NAME }}/${{ env.WEB_SERVICE_NAME }}:${{ github.sha }}"
          echo "Building WEB image: $IMAGE_TAG"
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet
          docker build -t "$IMAGE_TAG" ./web
          docker push "$IMAGE_TAG"
          echo "image=$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: Deploy WEB to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.WEB_SERVICE_NAME }}
          region: ${{ env.REGION }}
          image: ${{ steps.build_web.outputs.image }}
          wait: true

      - name: Fetch WEB URL
        id: urls
        run: |
          WEB_URL=$(gcloud run services describe ${{ env.WEB_SERVICE_NAME }} --region ${{ env.REGION }} --format='value(status.url)')
          echo "web_url=$WEB_URL" >> $GITHUB_OUTPUT
          echo "WEB URL: $WEB_URL"

  # 1) Build + Deploy API (only if api changed)
  deploy-api:
    needs: detect-changes
    if: needs.detect-changes.outputs.api == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: "read"
      id-token: "write"
    outputs:
      api_url: ${{ steps.urls.outputs.api_url }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud (WIF)
        uses: google-github-actions/auth@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
          workload_identity_provider: projects/${{ env.PROJECT_NUMBER }}/locations/global/workloadIdentityPools/ugtf-github-pool/providers/github-actions
          service_account: github-runner-ugtf@${{ env.PROJECT_ID }}.iam.gserviceaccount.com

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Build and Push API Docker Image
        id: build_api
        run: |
          IMAGE_TAG="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.API_SERVICE_NAME }}/${{ env.API_SERVICE_NAME }}:${{ github.sha }}"
          echo "Building API image: $IMAGE_TAG"
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet
          docker build -t "$IMAGE_TAG" ./services/upumi-backend
          docker push "$IMAGE_TAG"
          echo "image=$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: Deploy API to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.API_SERVICE_NAME }}
          region: ${{ env.REGION }}
          image: ${{ steps.build_api.outputs.image }}
          flags: >
            --add-cloudsql-instances=${{ env.PROJECT_ID }}:${{ env.REGION }}:upumi-postgres
            --set-env-vars=NODE_ENV=production
            --set-secrets=DATABASE_URL=UPUMI_DATABASE_URL:latest,JWT_SECRET=UPUMI_JWT_SECRET:latest,ADMIN_BOOTSTRAP_SECRET=UPUMI_ADMIN_BOOTSTRAP_SECRET:latest,DB_PASSWORD=UPUMI_DB_PASSWORD:latest
          wait: true

      - name: Fetch API URL
        id: urls
        run: |
          API_URL=$(gcloud run services describe ${{ env.API_SERVICE_NAME }} --region ${{ env.REGION }} --format='value(status.url)')
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT
          echo "API URL: $API_URL"

  # 2) Health check WEB (only if web deployed)
  health-check-web:
    needs: deploy-web
    if: always() && needs.deploy-web.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Health check WEB
        run: |
          WEB_URL="${{ needs.deploy-web.outputs.web_url }}"
          echo "Checking WEB at $WEB_URL..."
          for i in {1..12}; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$WEB_URL")
            if [ "$STATUS" = "200" ]; then
              echo "âœ… WEB healthy"
              exit 0
            fi
            echo "Waiting for WEB... status=$STATUS"
            sleep 5
          done
          echo "âŒ WEB did not become healthy"
          exit 1

  # 2) Health check API (only if api deployed) - AUTHENTICATED (no public allUsers)
  health-check-api:
    needs: deploy-api
    if: always() && needs.deploy-api.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: "read"
      id-token: "write"
    steps:
      - name: Authenticate to Google Cloud (WIF)
        uses: google-github-actions/auth@v2
        id: auth
        with:
          project_id: ${{ env.PROJECT_ID }}
          workload_identity_provider: projects/${{ env.PROJECT_NUMBER }}/locations/global/workloadIdentityPools/ugtf-github-pool/providers/github-actions
          service_account: github-runner-ugtf@${{ env.PROJECT_ID }}.iam.gserviceaccount.com
          token_format: "id_token"
          audience: "${{ needs.deploy-api.outputs.api_url }}"

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Health check API (/health) (authenticated)
        run: |
          API_URL="${{ needs.deploy-api.outputs.api_url }}"
          echo "Checking API at $API_URL/health (authenticated)..."

          for i in {1..12}; do
            TOKEN="${{ steps.auth.outputs.id_token }}"
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "Authorization: Bearer $TOKEN" \
              "$API_URL/health")

            if [ "$STATUS" = "200" ]; then
              echo "âœ… API healthy"
              exit 0
            fi

            echo "Waiting for API... status=$STATUS"
            sleep 5
          done

          echo "âŒ API did not become healthy"
          exit 1

  # 3) Lighthouse (only if web changed + web healthy)
  lighthouse-audit:
    needs: [deploy-web, health-check-web]
    if: always() && needs.deploy-web.result == 'success' && needs.health-check-web.result == 'success'
    runs-on: ubuntu-latest
    outputs:
      lighthouse_summary: ${{ steps.summary.outputs.lighthouse_summary }}
    steps:
      - name: Install Lighthouse CI + jq
        run: npm install -g @lhci/cli@0.13.x jq

      - name: Run Lighthouse (Desktop + Mobile)
        run: |
          WEB_URL="${{ needs.deploy-web.outputs.web_url }}"
          mkdir -p .lighthouseci

          echo "ðŸ Desktop..."
          lhci collect \
            --url="$WEB_URL" \
            --numberOfRuns=1 \
            --settings.formFactor=desktop \
            --settings.screenEmulation.mobile=false \
            --settings.throttlingMethod=provided || true

          DESKTOP_REPORT=$(find .lighthouseci -name "lhr-*.json" | sort | tail -n 1)
          cp "$DESKTOP_REPORT" ./lighthouse-desktop.json

          echo "ðŸ“± Mobile..."
          lhci collect \
            --url="$WEB_URL" \
            --numberOfRuns=1 \
            --settings.formFactor=mobile \
            --settings.throttlingMethod=simulate || true

          MOBILE_REPORT=$(find .lighthouseci -name "lhr-*.json" | sort | tail -n 1)
          cp "$MOBILE_REPORT" ./lighthouse-mobile.json

      - name: Extract Lighthouse Scores
        id: summary
        run: |
          get_score() { jq -r ".categories.$1.score" "$2"; }

          extract_summary() {
            REPORT="$1"; DEVICE="$2"
            PERF=$(get_score performance $REPORT)
            ACCESS=$(get_score accessibility $REPORT)
            BEST=$(jq -r '.categories["best-practices"].score' $REPORT)
            SEO=$(get_score seo $REPORT)
            LCP=$(jq -r '.audits["largest-contentful-paint"].numericValue' $REPORT)
            CLS=$(jq -r '.audits["cumulative-layout-shift"].numericValue' $REPORT)
            TBT=$(jq -r '.audits["total-blocking-time"].numericValue' $REPORT)
            echo "${DEVICE}: Performance=${PERF}, Accessibility=${ACCESS}, BestPractices=${BEST}, SEO=${SEO}, LCP=${LCP}ms, CLS=${CLS}, TBT=${TBT}ms"
          }

          DESKTOP_SUMMARY=$(extract_summary lighthouse-desktop.json "ðŸ–¥ï¸ Desktop")
          MOBILE_SUMMARY=$(extract_summary lighthouse-mobile.json "ðŸ“± Mobile")

          SUMMARY="Lighthouse Results:\n$DESKTOP_SUMMARY\n$MOBILE_SUMMARY"
          SUMMARY_ESCAPED=$(echo "$SUMMARY" | tr '\n' ' ' | tr -d '\r')
          echo "lighthouse_summary=$SUMMARY_ESCAPED" >> $GITHUB_OUTPUT

  # 4) Python SEO Audit (only if web changed + web healthy)
  seo-audit:
    needs: [deploy-web, health-check-web]
    if: always() && needs.deploy-web.result == 'success' && needs.health-check-web.result == 'success'
    runs-on: ubuntu-latest
    outputs:
      issues_summary: ${{ steps.summary.outputs.issues_summary }}
    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 lxml

      - name: Run SEO Audit
        run: |
          python - <<'EOF'
          import requests, json
          from bs4 import BeautifulSoup

          url = "${{ needs.deploy-web.outputs.web_url }}"
          resp = requests.get(url, timeout=20)
          soup = BeautifulSoup(resp.text, "lxml")

          issues = []
          if not soup.title or not soup.title.string or not soup.title.string.strip():
              issues.append("Missing <title>")
          if not soup.find("meta", attrs={"name": "description"}):
              issues.append("Missing meta description")
          if not soup.find("h1"):
              issues.append("Missing <h1> tag")

          report = {"url": url, "issues": issues, "total_issues": len(issues)}
          with open("seo-results.json", "w") as f:
              json.dump(report, f, indent=2)
          print(f"SEO issues: {len(issues)}")
          EOF

      - name: Generate SEO Summary
        id: summary
        run: |
          SUMMARY=$(python -c 'import json; d=json.load(open("seo-results.json")); i=d.get("issues",[]); print(", ".join(i[:5]) if i else "No issues detected")')
          echo "issues_summary=$SUMMARY" >> $GITHUB_OUTPUT

  # 5) Notify via Email (runs when either service changed)
  notify:
    needs: [detect-changes, deploy-web, deploy-api, health-check-web, health-check-api, lighthouse-audit, seo-audit]
    if: always() && (needs.detect-changes.outputs.web == 'true' || needs.detect-changes.outputs.api == 'true')
    runs-on: ubuntu-latest
    steps:
      - name: Send Email Summary
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USER }}
          password: ${{ secrets.EMAIL_PASS }}
          subject: "ðŸš€ UPUMI Deploy Report (path-filtered)"
          to: ono@ugtf.org
          from: UGTF CI Bot
          body: |
            âœ… Deployment pipeline finished

            Changed:
              - web: ${{ needs.detect-changes.outputs.web }}
              - api: ${{ needs.detect-changes.outputs.api }}

            WEB:
              - deploy: ${{ needs.deploy-web.result }}
              - health: ${{ needs.health-check-web.result }}
              - url: ${{ needs.deploy-web.outputs.web_url || 'skipped' }}

            API:
              - deploy: ${{ needs.deploy-api.result }}
              - health: ${{ needs.health-check-api.result }}
              - url: ${{ needs.deploy-api.outputs.api_url || 'skipped' }}

            ðŸ“Š Lighthouse (WEB):
              ${{ needs.lighthouse-audit.outputs.lighthouse_summary || 'skipped' }}

            ðŸ§© SEO (WEB):
              ${{ needs.seo-audit.outputs.issues_summary || 'skipped' }}
